<?php 
$tableParams = array(
	'tableId' 			=> 'wordpress-cache-objects-tree',
    'tableWidth'        => '4',
);
?>

<style><?php echo file_get_contents(dirname(__FILE__) . DIRECTORY_SEPARATOR . 'cacheObjects.css')?></style>

<div>
    <div class="generalTableDiv">
    		<fieldset>
    			<span class="generalTitle">General Statistics</span>
    			<table id=general_table">
    				<tbody>
    				    <tr><td>Hits</td>
    					<td id="hitsCount"></td></tr>
    					
    				    <tr><td>Misses</td>
    					<td id="missesCount"></td></tr>
    			     </tbody>
    			</table>
            </fieldset>
    </div>
    
    <div class="pieChartDiv">
        <canvas id="cache-statistics-chart" width="200" height="200" />
    </div>
</div>

<?php echo $this->zrayTable($tableParams); //zrayTableHtml ?>


<script type="text/javascript">

<?php echo $params['resources']['chart']; ?>

(function() {
	var storage = zray.getStorage('wordpressCacheObjectsTree');
	// create main table
	var maintable = zray.createGeneralTreeTable(storage, jQuery('#<?php echo $tableParams['tableId']; ?>'));
	maintable.setColumns([{
		label: 'name',
		propertyName: 'name',
		width: '25%',
		attributes: {'class': 'zdb-tree-table-cell-path zdb-ellipsis zdb-monospace'},
		getHtml: function(val, rec) {
			var cushion = $zendDevBar('<div>');
			/// either the node has children or this is an object with properties
			if (rec.children > 0) {
				cushion.addClass('zdb-tree-table-cell-path-expandable');
			}
			cushion.addClass('zdb-tree-table-cell-path-display');
			
			if (rec.parent.length > 1) {
				cushion.css('margin-left', (18 * rec.level) + 'px');
			}

			cushion.click(function(event){
				$zendDevBar(event.target).parent('td').click();
			});

			var formattedText = val;
			if (typeof formattedText == 'string' && formattedText.trim().length == 0) {
				formattedText = '[Empty String Key]';
				cushion.addClass('zdb-tree-table-system-data');
			} else if (formattedText > 32) {
				cushion.attr('title', formattedText);
				formattedText = zendDevBar.shorten(formattedText, 32);
			}
			
			return cushion.text(formattedText);
		}
	},
	{
		label: 'size',
		propertyName: 'size',
		width: '75%',
		attributes: {'class': 'zdb-monospace zdb-ellipsis'},
		getHtml: function(val, rec) {
			var cushion = $zendDevBar('<div>');
			cushion.attr('title', val);
			return cushion.text(val);
		}
	},
	{
		label: 'hits',
		propertyName: 'hits',
		width: '75%',
		attributes: {'class': 'zdb-monospace zdb-ellipsis'},
		getHtml: function(val, rec) {
			var cushion = $zendDevBar('<div>');
			cushion.attr('title', val);
			return cushion.text(val);
		}
	}]);
	// create main table - end

	zray.registerDataHandler('wordpress', 'cacheStats', function(statsData, requestData) {
		$zendDevBar('#hitsCount').text(statsData[0]);
		$zendDevBar('#missesCount').text(statsData[1]);
	});
	zray.registerDataHandler('wordpress', 'cacheObjects', function(extensionData, requestData) {
		storage.setData(extensionData);
	});


	(function() {
		zray.registerDataHandler('wordpress', 'cachePieStats', function(extensionData, requestData) {
			var colors = [
	            {'color': '#F7464A', 'highlight': '#FF5A5E'},
	            {'color': '#46BFBD', 'highlight': '#5AD3D1'},
	            {'color': '#FDB45C', 'highlight': '#FFC870'},
	            {'color': '#949FB1', 'highlight': '#A8B3C5'},
	            {'color': '#4D5360', 'highlight': '#616774'},
	            {'color': '#b48ead', 'highlight': '#b48eb3'},
	            {'color': '#5B90BF', 'highlight': '#5bbabf'}
	        ];
			var pieData = [];
			jQuery.each(extensionData, function(key, data) {
				pieData.push({'label': data.name, 'value': parseFloat(data.count), 'color': colors[key].color, 'highlight': colors[key].highlight});
			});

	       	var ctx = document.getElementById("cache-statistics-chart").getContext("2d");
	       	var myPie = new Chart(ctx).Pie(pieData);
		});
	})();
})();
</script>

